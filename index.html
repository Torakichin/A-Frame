<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>A-Frame VR視線タイマー移動 (安定版)</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <style>
      /* カーソルを見やすくするためのスタイル */
      #cursor {
        display: block;
        cursor: pointer;
      }
    </style>
    
    <script>
      /**
       * 視線カーソルがオブジェクトを注視した際に、カスタムタイマーによって移動を制御するコンポーネント。
       * A-Frame標準のfuseTimeoutが不安定な環境向け。
       */
      AFRAME.registerComponent('gaze-timer-mover', {
        schema: {
          // 移動に必要な注視時間 (ミリ秒)
          gazeTime: {type: 'number', default: 1500}, 
          // テレポートさせるエンティティ (カメラリグ) のセレクタ
          cameraRig: {type: 'selector', default: '#cameraRig'},
          // 移動速度（アニメーションのデュレーション）
          duration: {type: 'number', default: 800} // ms
        },

        init: function () {
          const el = this.el;
          const data = this.data;
          
          let timer = null;
          const cursorEl = document.querySelector('#cursor');
          const originalColor = '#FF0077';
          const timerRunningColor = '#FFFF00'; // 注視タイマー作動中の色 (明るい黄色)

          // --- 移動処理関数 ---
          const moveCamera = (intersection) => {
            // 既に移動処理が開始されている場合は無視
            if (data.cameraRig.getAttribute('animation')) {
              // 一度トリガーされたアニメーション属性を削除してリセットし、再トリガーに備える
              data.cameraRig.removeAttribute('animation');
            }

            const targetPosition = intersection.point;

            // 1. 移動先の新しい位置を計算 (カメラリグのY座標は0)
            const newPosition = {
              x: targetPosition.x,
              y: 0, 
              z: targetPosition.z
            };

            // 2. カメラリグを新しい位置へアニメーションで移動
            data.cameraRig.setAttribute('animation', {
              property: 'position',
              to: `${newPosition.x} ${newPosition.y} ${newPosition.z}`,
              dur: data.duration, 
              easing: 'easeInOutQuad',
              startEvents: 'moveStart',
              loop: 1, 
              enabled: true
            });

            // 3. アニメーションをトリガー
            data.cameraRig.emit('moveStart');
            console.log(`Gaze-moved after ${data.gazeTime}ms timer to: X=${newPosition.x.toFixed(2)}, Z=${newPosition.z.toFixed(2)}`);
          };

          // --- イベントリスナー設定 ---
          
          // 1. 注視開始 (mouseenter)
          el.addEventListener('mouseenter', function (evt) {
            // タイマーが既に動いていたら何もしない
            if (timer) return;

            // カーソルの色を変更し、タイマーが動いていることを視覚的に示す
            if (cursorEl) {
              cursorEl.setAttribute('material', 'color', timerRunningColor);
            }

            // 1.5秒後に移動処理を実行するように設定
            timer = setTimeout(() => {
              // タイマー完了: 移動処理を実行
              moveCamera(evt.detail.intersection);
              
              // 移動完了後、カーソルの色を元に戻す
              if (cursorEl) {
                cursorEl.setAttribute('material', 'color', originalColor);
              }
              timer = null; // タイマーをリセット
            }, data.gazeTime);
          });

          // 2. 注視中断/ブレ (mouseleave)
          el.addEventListener('mouseleave', function () {
            // タイマーが動いていたらキャンセル
            if (timer) {
              clearTimeout(timer);
              timer = null;
              
              // カーソルの色を元に戻す
              if (cursorEl) {
                cursorEl.setAttribute('material', 'color', originalColor);
              }
              console.log('Gaze timer interrupted.');
            }
          });
          
          // Raycasterで検出するためにclickableクラスを付与
          el.classList.add('clickable');
        }
      });
    </script>
  </head>
  <body>
    <a-scene id="scene">

      <!-- ============================================== -->
      <!-- カメラと視線制御グループ (リグ) -->
      <!-- ============================================== -->
      <a-entity id="cameraRig" position="0 0 0">
        <!-- カメラ: look-controlsはVRゴーグル（ヘッドトラッキング）に自動対応します -->
        <a-entity 
          camera look-controls 
          position="0 1.6 0" 
          id="head"
          raycaster="objects: .clickable"   <!-- clickableなオブジェクトを検出 -->
        >
          <!-- 視線カーソル: 注視を検出するために必須 -->
          <a-cursor 
            id="cursor"
            raycaster="objects: .clickable" 
            geometry="primitive: ring; radiusOuter: 0.01; radiusInner: 0.007"
            material="color: #FF0077; shader: flat"
            cursor=""  <!-- ★ fuse: true を削除し、純粋なカーソルとして使用 -->
          ></a-cursor>
        </a-entity>
      </a-entity>

      <!-- ============================================== -->
      <!-- シーンのオブジェクト -->
      <!-- ============================================== -->
      
      <!-- 地面: gaze-timer-moverを適用し、タイマーによる移動を可能にする -->
      <a-box 
        position="0 -.5 0" width="80" height="1" depth="100" 
        color="#32CD32" 
        shadow
        gaze-timer-mover="gazeTime: 1500" <!-- 1.5秒の注視が必要 -->
      ></a-box>
      
      <!-- オブジェクト配置例 1 (注視移動はできない) -->
      <a-box 
        position="-4 2 -5" width="4" height="4" depth="4" 
        color="#E0E0E0"                             
        shadow
      ></a-box>

      <!-- オブジェクト配置例 2 -->
      <a-sphere 
        position="0 1 -3" radius="1" 
        color="#783134"
        shadow
      ></a-sphere>
      
      <!-- オブジェクト配置例 3 -->
      <a-box 
        position="5 2 -10" width="3" height="3" depth="3" 
        rotation="0 90 0"                           
        color="#FF8C00"                             
        shadow
      ></a-box>

      <!-- 光源と空 -->
      <a-light type="ambient" color="#BBB"></a-light>
      <a-light type="directional" position="1 1 1" intensity="0.5"></a-light>
      <a-sky color="#63c6ff"></a-sky>

    </a-scene>
  </body>
</html>
