<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>自動歩行と昼夜変化のVRワールド</title>
    <script src="https://aframe.io/releases/1.1.0/aframe.min.js"></script>
  </head>
  <body>
    <a-scene>
      <a-assets>
        <img id="dayPanorama" src="day.jpg">
        <img id="nightPanorama" src="night.jpg">
      </a-assets>

      <a-box position="0 -0.5 -50" width="10" height="1" depth="100" color="#4CAF50"></a-box>

      <a-entity id="player" position="0 1.6 0"
        animation="property: position; to: 0 1.6 -95; dur: 60000; easing: linear; loop: true; dir: alternate-reverse">
        <a-entity camera look-controls wasd-controls="enabled: false"></a-entity>
      </a-entity>

      <a-sky id="sky" src="#dayPanorama"></a-sky> <a-entity id="ambient-light" light="type: ambient; intensity: 0.8"></a-entity>
      <a-entity id="sun-moon-light" light="type: directional; intensity: 0.5; castShadow: true" position="-10 30 -50"></a-entity>

      <a-entity id="day-night-cycle">
        <a-animation target="sky" attribute="material.src" from="#dayPanorama" to="#nightPanorama" dur="1" fill="forwards" delay="30000" begin="startDayCycle"></a-animation>
        <a-animation target="sky" attribute="material.src" from="#nightPanorama" to="#dayPanorama" dur="1" fill="forwards" delay="59999" begin="startDayCycle"></a-animation>

        <a-animation target="ambient-light" attribute="light.intensity" from="0.8" to="0.1" dur="30000" easing="linear" fill="forwards" begin="startDayCycle"></a-animation>
        <a-animation target="ambient-light" attribute="light.intensity" from="0.1" to="0.8" dur="30000" easing="linear" fill="forwards" delay="30000" begin="startDayCycle"></a-animation>

        <a-animation target="sun-moon-light" attribute="light.intensity" from="0.5" to="0.05" dur="30000" easing="linear" fill="forwards" begin="startDayCycle"></a-animation>
        <a-animation target="sun-moon-light" attribute="light.intensity" from="0.05" to="0.5" dur="30000" easing="linear" fill="forwards" delay="30000" begin="startDayCycle"></a-animation>

        <a-animation target="sun-moon-light" attribute="rotation" from="-90 0 0" to="90 0 0" dur="60000" easing="linear" loop="true" begin="startDayCycle"></a-animation>
      </a-entity>

      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const player = document.querySelector('#player');
          const dayNightCycle = document.querySelector('#day-night-cycle');

          // プレイヤーの移動アニメーションが1ループ完了するごとに昼夜サイクルをリセット
          player.addEventListener('animationend', function(event) {
            if (event.detail.name === 'animation__position') { // プレイヤーの移動アニメーションであることを確認
              dayNightCycle.querySelectorAll('a-animation').forEach(anim => {
                anim.setAttribute('startEvents', ''); // イベントリスナーを一時的に無効化
                anim.components.animation.reset(); // アニメーションをリセット
                anim.setAttribute('begin', 'startDayCycle'); // 再びイベントで開始できるように設定
              });
              dayNightCycle.emit('startDayCycle'); // 昼夜サイクルを再開
            }
          });

          // 初回のみ昼夜サイクルを開始
          document.querySelector('a-scene').addEventListener('loaded', function () {
            dayNightCycle.emit('startDayCycle');
          });
        });
      </script>

      <a-box position="0 0 -90">
        <a-box position="0 5 0" width="20" height="10" depth="15" color="#A0522D"></a-box>
        <a-cylinder position="-9 12 6" radius="2" height="10" color="#8B4513"></a-cylinder>
        <a-cylinder position="9 12 6" radius="2" height="10" color="#8B4513"></a-cylinder>
        <a-cylinder position="-9 12 -6" radius="2" height="10" color="#8B4513"></a-cylinder>
        <a-cylinder position="9 12 -6" radius="2" height="10" color="#8B4513"></a-cylinder>
        <a-cone position="-9 17 6" radius-bottom="2.5" radius-top="0" height="5" color="#696969"></a-cone>
        <a-cone position="9 17 6" radius-bottom="2.5" radius-top="0" height="5" color="#696969"></a-cone>
        <a-cone position="-9 17 -6" radius="2.5" height="5" color="#696969"></a-cone>
        <a-cone position="9 17 -6" radius="2.5" height="5" color="#696969"></a-cone>
        <a-cone position="0 12 0" radius-bottom="10" radius-top="0" height="8" color="#696969"></a-cone>
        <a-entity position="0 18 0" animation="property: rotation; to: 0 360 0; dur: 5000; easing: linear; loop: true">
          <a-box position="0 1 0" width="0.5" height="2" depth="0.5" color="#555"></a-box>
          <a-plane position="0.5 2 0" width="2" height="1" color="#FFD700" rotation="0 0 0"></a-plane>
        </a-entity>
      </a-entity>
      <a-entity position="0 0 -10">
        <a-box position="-2 2.5 0" width="0.5" height="5" depth="0.5" color="#A52A2A"></a-box>
        <a-box position="2 2.5 0" width="0.5" height="5" depth="0.5" color="#A52A2A"></a-box>
        <a-box position="0 5 0" width="4.5" height="0.5" depth="0.5" color="#A52A2A"></a-box>
        <a-box position="0 4.5 0" width="5.5" height="0.5" depth="0.5" color="#A52A2A"></a-box>
      </a-entity>
      <a-entity position="0 0 -30">
        <a-box position="-2 2.5 0" width="0.5" height="5" depth="0.5" color="#A52A2A"></a-box>
        <a-box position="2 2.5 0" width="0.5" height="5" depth="0.5" color="#A52A2A"></a-box>
        <a-box position="0 5 0" width="4.5" height="0.5" depth="0.5" color="#A52A2A"></a-box>
        <a-box position="0 4.5 0" width="5.5" height="0.5" depth="0.5" color="#A52A2A"></a-box>
      </a-entity>
      <a-entity position="0 0 -50">
        <a-box position="-2 2.5 0" width="0.5" height="5" depth="0.5" color="#A52A2A"></a-box>
        <a-box position="2 2.5 0" width="0.5" height="5" depth="0.5" color="#A52A2A"></a-box>
        <a-box position="0 5 0" width="4.5" height="0.5" depth="0.5" color="#A52A2A"></a-box>
        <a-box position="0 4.5 0" width="5.5" height="0.5" depth="0.5" color="#A52A2A"></a-box>
      </a-entity>
      <a-entity position="0 0 -70">
        <a-box position="-2 2.5 0" width="0.5" height="5" depth="0.5" color="#A52A2A"></a-box>
        <a-box position="2 2.5 0" width="0.5" height="5" depth="0.5" color="#A52A2A"></a-box>
        <a-box position="0 5 0" width="4.5" height="0.5" depth="0.5" color="#A52A2A"></a-box>
        <a-box position="0 4.5 0" width="5.5" height="0.5" depth="0.5" color="#A52A2A"></a-box>
      </a-entity>
      <a-entity position="15 0 -20">
        <a-box position="0 2 0" width="5" height="4" depth="5" color="#DEB887"></a-box>
        <a-cone position="0 4.5 0" radius-bottom="3.5" radius-top="0" height="3" color="#A52A2A"></a-cone>
      </a-entity>
      <a-cylinder position="-15 0 -40" radius="7" height="0.1" color="#4682B4"></a-cylinder>
      <a-entity position="18 0 -60">
        <a-cylinder position="0 7 0" radius="3" height="14" color="#808080"></a-cylinder>
        <a-cone position="0 15 0" radius-bottom="3.5" radius-top="0" height="4" color="#696969"></a-cone>
      </a-entity>
      <a-sphere position="5 1.6 -5" radius="0.8" color="#ADD8E6"
        animation="property: position; to: 8 1.6 -10; dur: 4000; easing: linear; loop: true; dir: alternate"></a-sphere>
      <a-box position="-7 1.6 -15" width="1.5" height="1.5" depth="1.5" color="#FFB6C1"
        animation="property: position; to: -10 1.6 -20; dur: 5000; easing: linear; loop: true; dir: alternate"></a-box>
      <a-sphere position="12 1.6 -35" radius="0.9" color="#90EE90"
        animation="property: position; to: 15 1.6 -40; dur: 4500; easing: linear; loop: true; dir: alternate"></a-sphere>
      <a-box position="-18 1.6 -55" width="1.2" height="1.2" depth="1.2" color="#DDA0DD"
        animation="property: position; to: -21 1.6 -60; dur: 6000; easing: linear; loop: true; dir: alternate"></a-box>
      <a-sphere position="7 1.6 -75" radius="0.7" color="#FFDAB9"
        animation="property: position; to: 10 1.6 -80; dur: 5500; easing: linear; loop: true; dir: alternate"></a-sphere>
    </a-scene>
  </body>
</html>
