<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>A-Frame VR視線移動対応</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <style>
      /* カーソルを見やすくするためのスタイル */
      #cursor {
        display: block;
        cursor: pointer;
      }
    </style>
    
    <script>
      /**
       * 視線カーソルがオブジェクトを注視した際に、その場所へカメラリグを移動させるコンポーネント
       */
      AFRAME.registerComponent('gaze-mover', {
        schema: {
          // テレポート先のオブジェクトとの距離を設定
          distance: {type: 'number', default: 0.5}, // ターゲットの少し手前に着地
          // テレポートさせるエンティティ (カメラリグ) のセレクタ
          cameraRig: {type: 'selector', default: '#cameraRig'},
          // 移動速度（アニメーションのデュレーション）
          duration: {type: 'number', default: 800} // ms
        },

        init: function () {
          const el = this.el; // このコンポーネントがアタッチされた要素（地面）
          const data = this.data;
          
          // カーソルが注視を完了したとき（fusing）のイベントリスナーを設定
          el.addEventListener('fusing', function (evt) {
            // evt.detail.intersection は、Raycasterがオブジェクトと交差した正確な位置情報を含む
            const intersection = evt.detail.intersection;

            if (!intersection || !data.cameraRig) {
              console.error("Intersection data missing or Camera Rig not found.");
              return;
            }

            const targetPosition = intersection.point;

            // 1. 移動先の新しい位置を計算
            // Y座標は、カメラリグを地面(0)に配置し、頭(1.6)で高さを調整
            const newPosition = {
              x: targetPosition.x,
              y: 0, // カメラリグのY座標は0
              z: targetPosition.z
            };

            // 2. カメラリグを新しい位置へアニメーションで移動
            data.cameraRig.setAttribute('animation', {
              property: 'position',
              to: `${newPosition.x} ${newPosition.y} ${newPosition.z}`,
              dur: data.duration, 
              easing: 'easeInOutQuad',
              startEvents: 'moveStart',
              loop: 1, 
              enabled: true
            });

            // 3. アニメーションをトリガー
            data.cameraRig.emit('moveStart');
            console.log(`Gaze-moved to: X=${newPosition.x.toFixed(2)}, Z=${newPosition.z.toFixed(2)}`);
          });
          
          // fuser: cursor が必要とするので、clickable クラスを追加
          el.classList.add('clickable');
        }
      });
    </script>
  </head>
  <body>
    <a-scene id="scene">

      <!-- ============================================== -->
      <!-- カメラと視線制御グループ (リグ) -->
      <!-- ============================================== -->
      <a-entity id="cameraRig" position="0 0 0">
        <!-- カメラ: look-controlsはVRゴーグル（ヘッドトラッキング）に自動対応します -->
        <a-entity 
          camera look-controls 
          position="0 1.6 0" 
          id="head"
          raycaster="objects: .clickable"   <!-- clickableなオブジェクトを検出 -->
        >
          <!-- 視線カーソル: 注視を検出するために必須 -->
          <a-cursor 
            id="cursor"
            raycaster="objects: .clickable" 
            geometry="primitive: ring; radiusOuter: 0.01; radiusInner: 0.007"
            material="color: #FF0077; shader: flat"
            cursor="fuse: true; fuseTimeout: 3000"  <!-- 注視時間を1500ms (1.5秒) に設定 -->
          ></a-cursor>
        </a-entity>
      </a-entity>

      <!-- ============================================== -->
      <!-- シーンのオブジェクト -->
      <!-- ============================================== -->
      
      <!-- 地面: gaze-moverを適用し、注視による移動を可能にする -->
      <a-box 
        position="0 -.5 0" width="80" height="1" depth="100" 
        color="#32CD32" 
        shadow
        gaze-mover
      ></a-box>
      
      <!-- オブジェクト配置例 1 (注視移動はできない) -->
      <a-box 
        position="-4 2 -5" width="4" height="4" depth="4" 
        color="#E0E0E0"                             
        shadow
      ></a-box>

      <!-- オブジェクト配置例 2 -->
      <a-sphere 
        position="0 1 -3" radius="1" 
        color="#783134"
        shadow
      ></a-sphere>
      
      <!-- オブジェクト配置例 3 -->
      <a-box 
        position="5 2 -10" width="3" height="3" depth="3" 
        rotation="0 90 0"                           
        color="#FF8C00"                             
        shadow
      ></a-box>

      <!-- 光源と空 -->
      <a-light type="ambient" color="#BBB"></a-light>
      <a-light type="directional" position="1 1 1" intensity="0.5"></a-light>
      <a-sky color="#63c6ff"></a-sky>

    </a-scene>
  </body>
</html>
