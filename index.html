<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebXR GLB AR表示</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        /* ARモードに入るためのボタンのスタイル */
        #enter-ar-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50; /* Green */
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 8px;
            z-index: 9999;
        }
    </style>
</head>
<body style='margin : 0px; overflow: hidden;'>

    <button id="enter-ar-button">ARを開始</button>

    <a-scene 
        renderer="logarithmicDepthBuffer: true;"
        ar-hit-test="doHitTest: true;"
        webxr="requiredFeatures: ['hit-test', 'dom-overlay'];"
        vr-mode-ui="enabled: false">
        <a-assets>
            <a-asset-item id="my-glb-model" src="apple.glb"></a-asset-item>
        </a-assets>

        <a-entity 
            gltf-model="#my-glb-model"
            visible="false"
            scale="0.1 0.1 0.1" id="ar-object">
        </a-entity>

        <a-entity camera position="0 1.6 0"></a-entity>
    </a-scene>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const scene = document.querySelector('a-scene');
            const enterARButton = document.getElementById('enter-ar-button');
            const arObject = document.getElementById('ar-object');

            // WebXR ARセッション開始ボタンのクリックイベント
            enterARButton.addEventListener('click', async () => {
                try {
                    // ARセッションを開始
                    await scene.enterAR();
                    enterARButton.style.display = 'none'; // ボタンを非表示にする

                    // ARセッション開始後、ユーザーがタップした場所にモデルを配置する処理
                    // これはWebXRのヒットテストAPIを使って実装します。
                    // A-Frameのar-hit-testコンポーネントは、このロジックをラップしていることが多いです。
                    // 以下のコードは概念的なものであり、ar-hit-testコンポーネントの内部ロジックに依存します。
                    scene.addEventListener('ar-hit-test-result', (event) => {
                        const hit = event.detail.hit;
                        if (hit) {
                            // ヒットした場所にモデルを配置
                            arObject.setAttribute('position', {
                                x: hit.position.x,
                                y: hit.position.y,
                                z: hit.position.z
                            });
                            arObject.setAttribute('visible', 'true');
                            // 一度配置したら、再度タップで移動させたい場合はこのイベントリスナーを維持するか、
                            // タップで毎回新しいモデルを生成するなど、ロジックを調整します。
                        }
                    });

                } catch (error) {
                    console.error("Failed to enter AR:", error);
                    alert("ARモードを開始できませんでした。お使いのデバイスがWebXR ARに対応しているか、ブラウザのバージョンを確認してください。");
                }
            });

            // WebXRセッションが終了したときの処理
            scene.addEventListener('exit-vr', () => {
                enterARButton.style.display = 'block'; // ボタンを再表示
                arObject.setAttribute('visible', 'false'); // モデルを非表示
            });

            // WebXRが利用可能かどうかをチェック
            if (navigator.xr && navigator.xr.isSessionSupported) {
                navigator.xr.isSessionSupported('immersive-ar')
                    .then((supported) => {
                        if (!supported) {
                            enterARButton.textContent = "AR非対応";
                            enterARButton.disabled = true;
                            enterARButton.style.backgroundColor = "#ccc";
                        }
                    })
                    .catch((error) => {
                        console.error("Error checking WebXR support:", error);
                        enterARButton.textContent = "ARエラー";
                        enterARButton.disabled = true;
                        enterARButton.style.backgroundColor = "#ccc";
                    });
            } else {
                enterARButton.textContent = "WebXR未対応";
                enterARButton.disabled = true;
                enterARButton.style.backgroundColor = "#ccc";
            }
        });
    </script>
</body>
</html>
